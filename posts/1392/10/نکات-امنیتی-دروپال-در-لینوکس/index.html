<!doctype html><html lang="fa" dir="rtl"><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-HTH8HV1F9Z"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-HTH8HV1F9Z', { 'anonymize_ip': false });
}
</script><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="keywords" content="امنیت دروپال,لینوکس,مجوز فایل ها,امنیت لینوکس,دروپال,SGID,SUID,Debian,Linux,apache,php-fpm,سطح دسترسی فایل ها,مشکل دسترسی دروپال"><meta name="geo.region" content="IRAN"><link rel="canonical" href="https://hejazee.ir/posts/1392/10/%D9%86%DA%A9%D8%A7%D8%AA-%D8%A7%D9%85%D9%86%DB%8C%D8%AA%DB%8C-%D8%AF%D8%B1%D9%88%D9%BE%D8%A7%D9%84-%D8%AF%D8%B1-%D9%84%DB%8C%D9%86%D9%88%DA%A9%D8%B3/"><link rel="shortcut icon" href="/favicon.ico" type="image/png"><title>نکات امنیتی دروپال در لینوکس | وبلاگ رسمی احمد حجازی</title><link rel="stylesheet" href="/lib/bootstrap-5.1.3-dist/css/bootstrap.rtl.min.css"><link rel="stylesheet" href="/lib/fontawesome-free-5.15.2-web/css/all.min.css"><link rel="stylesheet" href="/fonts/fonts.css"><link rel="stylesheet" href="/scss/index.172bdd1266bb92eb39450b3215cc97ecd4d7ec43ae649679fe3140f189d01c32.css" integrity="sha256-FyvdEma7kus5RQsyFcyX7NTX7EOuZJZ5/jFA8YnQHDI=" crossorigin="anonymous"></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-dark" id="farsaran-header-nav"><div class="container"><a class="navbar-brand order-0 flex-grow-1 flex-lg-grow-0" href="/"><img src="/logo.svg" alt="وبلاگ رسمی احمد حجازی" height="34"></a>
<button class="navbar-toggler order-2 order-lg-1" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="نمایش منو">
<span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse mb-3 mb-lg-0" id="navbarSupportedContent"><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item"><a class="nav-link" href="/contact/">تماس</a></li><li class="nav-item"><a class="nav-link" href="/about/">درباره</a></li></ul></div></div></nav><div class="container mt-4"><div class="row"><div class="col-md-9"><header><h1 class="post-title fw-bold fs-2"><a class="text-dark" href="/posts/1392/10/%D9%86%DA%A9%D8%A7%D8%AA-%D8%A7%D9%85%D9%86%DB%8C%D8%AA%DB%8C-%D8%AF%D8%B1%D9%88%D9%BE%D8%A7%D9%84-%D8%AF%D8%B1-%D9%84%DB%8C%D9%86%D9%88%DA%A9%D8%B3/">نکات امنیتی دروپال در لینوکس</a></h1></header><small class="d-block text-secondary post-date">ارسال شده در
<time datetime="2014-01-06">Jan 6, 2014</time></small><article class="blog-post" role="article" typeof="schema:Article"><img src="drupalsecurity.jpg" width="150" height="155" alt="Drupal security" style="float:right;padding-left:10px"><p>برای میزبانی دروپال در هاست های اشتراکی، برخی دغدغه های امنیتی وجود دارد. که من در این جا برخی از آن ها را مطرح می کنم. این مطلب برای مدیران سرور مفید خواهد بود.<br>سیستم عامل مورد شرح در این مطلب، لینوکس Debian 6 squeeze می باشد و دروپال مورد استفاده نسخه ی 7.25 می باشد. گرچه سایر نسخه ها و توزیع های لینوکس و دروپال نیز، مشابه خواهند بود.</p><h3><strong>مجوز فایل های اصلی دروپال</strong></h3><p>یک کانفیگ بسیار مناسب و متداول برای میزبانی اپلیکیشن های PHP به این صورت است که از وب سرور apache2 همراه با ماژول fastcgi و سرویس php-fpm استفاده می شود.<br>برای شرح بیشتر راجع به این نوع کانفیگ، به لینک زیر مراجعه کنید. دقت کنید که ادامه ی مطلب دقیقا بر اساس لینک زیر <u>نمی باشد</u>. لینک زیر فقط برای راه اندازی یک حالت خاص از کانفیگی که نام بردم می باشد:<br><a href="http://www.makina-corpus.org/blog/install-drupal-php-fpm-fastcgi-apache-and-chroot-php-fpm" target="_blank">Install Drupal in php-fpm (fastcgi) with Apache and a chroot php-fpm</a></p><p><strong>نکته:</strong><a href="http://www.hejazee.ir/node/295" title="تشریح مجوز های فایل ها در لینوکس">برای شرح بیشتر در خصوص مجوز ها در لینوکس، این لینک را مطالعه کنید</a></p><p>در این پیکربندی، ما برای میزبانی هر سایت، یک کاربر جدید در لینوکس ایجاد می کنیم و در php-fpm یک pool جدید ایجاد می کنیم و تنظیم می کنیم که php-fpm برای هر سایت، با سطح دسترسی و هویت کاربر صاحب سایت اجرا شود.<br>فایده ی این کار این است که اگر چندین سایت مختلف داشته باشیم، هر سایت با مجوز های صاحب همان سایت اجرا می شود و اگر نفوذگر بتواند به یکی از سایت ها نفوذ کند، به سایر سایت ها دسترسی نخواهد داشت.</p><p>اما روال اجرای کار به این سادگی هم نیست. چند تا نکته را باید مد نظر قرار داد:</p><p>اولا وب سرور apache معمولا تحت کاربر www-data و گروه www-data اجرا می شود و وب سرور باید بتواند به فایل های دروپال (دست کم، پوشه ی اصلی سایت و پوشه ی files) دسترسی داشته باشد.<br>ثانیا، باید طوری تنظیم کنیم که سایر کاربرها، به جز www-data به فایل ها دسترسی نداشته باشند.</p><p>برای رسیدن به هدف اول، کافی است که group owner فایل های دروپال را به www-data تغییر دهیم.</p><pre class="brush: bash">
chmod 711 /home/siteuser
chown siteuser:www-data -R /home/siteuser/public_html
chmod 750 /home/siteuser/public_html</pre><p>اکنون که group owner فایل های دروپال با www-data تنظیم شده، باید مجوز فایل ها را طوری تنظیم کنیم که فقط php و apache به آن ها دسترسی داشته باشند. برای این منظور، مجوز پوشه ها را برابر 750 و مجوز فایل ها را برابر 640 در نظر می گیریم:</p><pre class="brush: bash">
cd /home/siteuser/public_html
find -type d -exec chmod 750 {} \;
find -type f -exec chmod 640 {} \;
</pre><h3><strong>مجوز فایل های خاص</strong></h3><p>همچنین باید مجوز پوشه ی اصلی سایت و فایل settings.php را تنظیم کنیم. (البته این کار توسط دروپال هم انجام می شود.)</p><pre class="brush: bash">
chmod 550 sites/default
chmod 440 sites/default/settings.php
</pre><h3><strong>مجوز فایل های جدید</strong></h3><p>اکنون مشکل در گام اول برطرف شده است، اما در گام بعدی، متوجه می شویم که فایل های جدیدی که توسط دروپال ایجاد می شود، مجوزهایشان صحیح نیست.<br>دو نوع فایل توسط دروپال قابل ایجاد است. یکی فایل هایی که مستقیما توسط php ایجاد شود. و دیگری فایل هایی که کاربر در سایت آپلود می کند.</p><p>تفاوت این دو دسته فایل در این است که در حالت اول، صرفا فایل ایجاد می شود، اما در حالت دوم، فایل پس از ایجاد، توسط تابع <a href="http://api.drupal.org/api/drupal/includes!file.inc/function/drupal_chmod/7">drupal_chmod</a> مجوز دهی می شود. عمده ی تمرکز ما روی حالت دوم است. زیرا حالت اول معمولا رخ نمی دهد.</p><p>برای تغییر مجوز فایل های ایجاد شده توسط PHP باید از دستور <a href="http://www.cyberciti.biz/tips/understanding-linux-unix-umask-value-usage.html">umask</a> استفاده کنیم. با توجه به این که می خواهیم کاربر other به فایل ها هیچ دسترسی نداشته باشد، umask قابل استفاده 0027 می باشد. ساده ترین راه برای انچام این تنظیم، این است که خط زیر را به ابتدای فایل index.php دروپال اضافه کنیم. (ظاهرا می توان آن را به فایل settings.php هم اضافه کرد که در این صورت بهتر خواهد بود.)</p><pre class="brush: php">
umask(0027);
</pre><p>به این ترتیب، پوشه هایی که توسط php ایجاد می شوند، با مجوز 750 و فایل ها با مجوز 640 ایجاد خواهند شد که مطلوب ماست.</p><p>نکته ی دیگر این است که فایل هایی که توسط کاربر آپلود می شوند (مانند فایل های ضمیمه ی ارسال شده در node ها) به طور خودکار توسط دروپال مجوز 644 و پوشه ها مجوز 755 می گیرند و این مطلوب ما نیست.</p><p>خوشبختانه دروپال گزینه ای برای تنظیم این موضوع دارد. یک variable موجود است به نام file_chmod_directory که مجوز پوشه های جدید را مشخص می کند و variable دیگری به نام file_chmod_file وجود داره که مجوز فایل های جدید را مشخص می کند. می توان این دو variable را به کمک تابع variable_set تنظیم کرد. اما روش ساده تر و ایمن تر این است که دو تا خط زیر را به انتهای فایل settings.php دروپال اضافه کنیم.</p><p>دو خط زیر سبب می شود که variable های فوق override شوند و از مقادیر مشخص شده در فایل settings.php استفاده شود:</p><pre class="brush: php">
$conf[&#39;file_chmod_directory&#39;] = octdec(&#39;0750&#39;);
$conf[&#39;file_chmod_file&#39;] = octdec(&#39;0640&#39;);
</pre><p>سپس فایل settings.php را ذخیره می کنیم (دقت کنید که این فایل read only است و باید در موقع ذخیره کردن با برنامه ی vim، از ! استفاده کرد.)</p><h3><strong>صاحب فایل های آپلود شده و ایجاد شده ی جدید</strong></h3><p>آخرین موضوع برای حل کردن این است که وقتی یک فایل جدید در دروپال آپلود می شود، از آن جایی که فایل توسط php ذخیره می شود که owner سایت ذخیره می شود. در حالی که ما می خواهیم group owner آن www-data باشد. چون در غیر این صورت در فایل توسط apache قابل serve شدن نخواهد بود و بارز ترین و سریع ترین واکنشی که مشاهده می کنیم این است که دروپال بدون استایل لود می شود و کلیه ی صفحات سایت بدون هیچ شکل و شمایلی نشان داده می شوند و یا کد های javascript اجرا نمی شود.</p><p>اگر در این حالت firebug را باز کنیم، می بینیم که علت بروز این مشکل، خطای 403 در هنگام لود شدن استایل ها و فایل های جاوااسکریپ می باشد.</p><p>برای رفع این مشکل، می توانیم مجوز <a href="http://www.library.yale.edu/wsg/docs/permissions/sgid.htm">sgid</a> را برای پوشه ی files تنظیم کنیم:</p><pre class="brush: bash">
cd /home/siteuser/public_html/sites/default
chown siteuser:www-data files
chmod 2750 files
</pre><p>به این ترتیب، فایل های جدید ایجاد شده، دارای group owner وب سرور (www-data) خواهند بود.</p><p>روش بهتر:</p><pre class="brush: bash">
cd /home/siteuser/public_html
chown siteuser:www-data -R .
find -type d -exec chmod 2750 {} \;
</pre><p>امیدوارم که این مطلب آموزشی مورد استفاده ی شما قرار گرفته باشد. لطفا نظرات خود را برای من ارسال کنید.</p><p><strong>نکته</strong>: برای رفع این مشکلات، همچنین می توان از <a href="https://wiki.debian.org/Permissions">ACL</a> ها استفاده کرد که البته تنظیم آن ها قدری پیچیده تر است نیاز به پشتیبانی هسته ی لینوکس و filesystem دارد و ممکن است در پست دیگری آن را شرح دهم.</p><h3><strong>لینک های مرتبط:</strong></h3><p><a href="https://drupal.org/node/244924" target="_blank">Securing file permissions and ownership</a></p><p><a href="https://drupal.org/node/1825824" target="_blank">Securing file permissions using Linux ACLs</a></p><div style="clear:both"></div></article><div id="comments"><script>
      var disqus_config = function () { 
        this.language = "fa";
      };
    </script><div id="disqus_thread"></div><script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hejazee" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><aside class="col-md-3 mt-4"><h3>Monthly Archive</h3><ul><li><a href="/month/1395-06/" title="All posts from 1395-06">1395-06</a> (1)</li><li><a href="/month/1395-01/" title="All posts from 1395-01">1395-01</a> (1)</li><li><a href="/month/1394-12/" title="All posts from 1394-12">1394-12</a> (3)</li><li><a href="/month/1394-08/" title="All posts from 1394-08">1394-08</a> (1)</li><li><a href="/month/1394-07/" title="All posts from 1394-07">1394-07</a> (1)</li><li><a href="/month/1394-03/" title="All posts from 1394-03">1394-03</a> (1)</li><li><a href="/month/1394-02/" title="All posts from 1394-02">1394-02</a> (1)</li><li><a href="/month/1393-12/" title="All posts from 1393-12">1393-12</a> (1)</li><li><a href="/month/1393-07/" title="All posts from 1393-07">1393-07</a> (1)</li><li><a href="/month/1393-06/" title="All posts from 1393-06">1393-06</a> (2)</li><li><a href="/month/1393-05/" title="All posts from 1393-05">1393-05</a> (2)</li><li><a href="/month/1393-04/" title="All posts from 1393-04">1393-04</a> (4)</li><li><a href="/month/1393-03/" title="All posts from 1393-03">1393-03</a> (5)</li><li><a href="/month/1393-02/" title="All posts from 1393-02">1393-02</a> (1)</li><li><a href="/month/1393-01/" title="All posts from 1393-01">1393-01</a> (4)</li><li><a href="/month/1392-12/" title="All posts from 1392-12">1392-12</a> (5)</li><li><a href="/month/1392-10/" title="All posts from 1392-10">1392-10</a> (5)</li><li><a href="/month/1392-06/" title="All posts from 1392-06">1392-06</a> (1)</li><li><a href="/month/1392-04/" title="All posts from 1392-04">1392-04</a> (1)</li><li><a href="/month/1392-02/" title="All posts from 1392-02">1392-02</a> (1)</li><li><a href="/month/1392-01/" title="All posts from 1392-01">1392-01</a> (5)</li><li><a href="/month/1391-11/" title="All posts from 1391-11">1391-11</a> (5)</li><li><a href="/month/1391-10/" title="All posts from 1391-10">1391-10</a> (4)</li><li><a href="/month/1391-09/" title="All posts from 1391-09">1391-09</a> (2)</li><li><a href="/month/1391-08/" title="All posts from 1391-08">1391-08</a> (3)</li><li><a href="/month/1391-07/" title="All posts from 1391-07">1391-07</a> (6)</li><li><a href="/month/1391-05/" title="All posts from 1391-05">1391-05</a> (1)</li><li><a href="/month/1391-04/" title="All posts from 1391-04">1391-04</a> (1)</li><li><a href="/month/1391-03/" title="All posts from 1391-03">1391-03</a> (2)</li><li><a href="/month/1391-02/" title="All posts from 1391-02">1391-02</a> (4)</li><li><a href="/month/1391-01/" title="All posts from 1391-01">1391-01</a> (6)</li><li><a href="/month/1390-12/" title="All posts from 1390-12">1390-12</a> (9)</li><li><a href="/month/1390-11/" title="All posts from 1390-11">1390-11</a> (8)</li><li><a href="/month/1390-10/" title="All posts from 1390-10">1390-10</a> (7)</li><li><a href="/month/1390-09/" title="All posts from 1390-09">1390-09</a> (4)</li><li><a href="/month/1390-08/" title="All posts from 1390-08">1390-08</a> (7)</li><li><a href="/month/1390-07/" title="All posts from 1390-07">1390-07</a> (14)</li><li><a href="/month/1390-06/" title="All posts from 1390-06">1390-06</a> (18)</li></ul></aside></div></div><footer id="footer-wrapper"><div id="footer-bottom-wrapper"><div class="container"><div class="row"><div class="col-12"><p dir="ltr">&copy; Copyright 2011-2022 * Ahmad Hejazee * All rights reserved.</p><small dir="ltr">Proudly Powered by Drupal 10 ;)</small></div></div></div></div></footer><script src="/lib/jQuery/jquery-3.6.0.min.js"></script>
<script src="/lib/bootstrap-5.1.3-dist/js/bootstrap.bundle.min.js"></script></body></html>