<!doctype html><html lang="fa" dir="rtl"><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-HTH8HV1F9Z"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-HTH8HV1F9Z', { 'anonymize_ip': false });
}
</script><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="geo.region" content="IRAN"><link rel="canonical" href="https://hejazee.ir/posts/1391/09/%D9%85%D9%82%D8%AF%D9%85%D9%87-%D8%A7%DB%8C-%D8%A8%D8%B1-%DA%A9%D9%84%D8%A7%D8%B3-entityfieldquery-%D8%AF%D8%B1%D9%88%D9%BE%D8%A7%D9%84-%D8%A8%D8%B1%D8%A7%DB%8C-%D9%BE%D8%B1%D8%B3-%D9%88-%D8%AC%D9%88-%D8%A7%D8%B2-entity-%D9%87%D8%A7-%D9%88-%D9%81%DB%8C%D9%84%D8%AF-%D9%87%D8%A7/"><link rel="shortcut icon" href="/favicon.ico" type="image/png"><title>مقدمه ای بر کلاس EntityFieldQuery دروپال برای پرس و جو از entity ها و فیلد ها | وبلاگ رسمی احمد حجازی</title><link rel="stylesheet" href="/lib/bootstrap-5.1.3-dist/css/bootstrap.rtl.min.css"><link rel="stylesheet" href="/lib/fontawesome-free-5.15.2-web/css/all.min.css"><link rel="stylesheet" href="/fonts/fonts.css"><link rel="stylesheet" href="/scss/index.172bdd1266bb92eb39450b3215cc97ecd4d7ec43ae649679fe3140f189d01c32.css" integrity="sha256-FyvdEma7kus5RQsyFcyX7NTX7EOuZJZ5/jFA8YnQHDI=" crossorigin="anonymous"></head><body><nav class="navbar navbar-expand-lg navbar-dark bg-dark" id="farsaran-header-nav"><div class="container"><a class="navbar-brand order-0 flex-grow-1 flex-lg-grow-0" href="/"><img src="/logo.svg" alt="وبلاگ رسمی احمد حجازی" height="34"></a>
<button class="navbar-toggler order-2 order-lg-1" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="نمایش منو">
<span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse mb-3 mb-lg-0" id="navbarSupportedContent"><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item"><a class="nav-link" href="/contact/">تماس</a></li><li class="nav-item"><a class="nav-link" href="/about/">درباره</a></li></ul></div></div></nav><div class="container mt-4"><div class="row"><div class="col-md-9"><header><h1 class="post-title fw-bold fs-2"><a class="text-dark" href="/posts/1391/09/%D9%85%D9%82%D8%AF%D9%85%D9%87-%D8%A7%DB%8C-%D8%A8%D8%B1-%DA%A9%D9%84%D8%A7%D8%B3-entityfieldquery-%D8%AF%D8%B1%D9%88%D9%BE%D8%A7%D9%84-%D8%A8%D8%B1%D8%A7%DB%8C-%D9%BE%D8%B1%D8%B3-%D9%88-%D8%AC%D9%88-%D8%A7%D8%B2-entity-%D9%87%D8%A7-%D9%88-%D9%81%DB%8C%D9%84%D8%AF-%D9%87%D8%A7/">مقدمه ای بر کلاس EntityFieldQuery دروپال برای پرس و جو از entity ها و فیلد ها</a></h1></header><small class="d-block text-secondary post-date">ارسال شده در
<time datetime="2012-12-18">Dec 18, 2012</time></small><article class="blog-post" role="article" typeof="schema:Article"><p>دروپال 7 یک API جدید به نام EntityFieldQuery ایجاد کرده است. API فوق یک کلاس است که به کمک آن می توان به سهولت و سرعت زیاد، از کلیه ی entity ها (از جمله node ها) و فیلد های موجود درسایت گزارش گیری کرد.</p><p>لایه ی انتزاع پایگاه داده (Database abstraction layer) دروپال 7 خیلی غنی تر از نسخه های پیشین دروپال است. با این حال، بازهم برای کار با پایگاه داده در دروپال 7 به گونه ای نیاز به ایجاد query های SQL می باشد.</p><p>اما کلاس EntityFieldQuery کمک می کند که بدون داشتن دانش SQL از فیلدها و entity ها query های گوناگون بگیریم.</p><p>خود هسته ی دروپال هم از EntityFieldQuery به عنوان یک ابزار استفاده می کند. که در بسیاری از موارد فقط برای این استفاده شده که بررسی کند که آیا یک فیلد با یک مقدار مشخصی موجود هست یا خیر.</p><p>در زیر این کلاس مفید را بررسی می کنیم و با هم برخی از ویژگی های آن را یاد میگیریم:</p><h3 style="font-weight:700">شروع Query</h3><p>برای شروع کافی است که یک آبجکت جدید از کلاس EntityFieldQuery ایجاد کنیم:</p><pre class="brush:php">
$query = new EntityFieldQuery();
</pre><p>خیلی ساده است. اینطور نیست؟ این همه ی چیزی است که برای شروع نیاز داریم.
اکنون اجازه دهید مقداری شرط به query مان اضافه کنیم:</p><pre class="brush:php">
$query
 ->entityCondition('entity_type', 'node')
 ->entityCondition('bundle', 'article')
 ->propertyCondition('status', 1)
 ->propertyOrderBy('created', 'DESC');
</pre><p>پیش از هر چیز، ممکن است عدم وجود سمیکالن در انتهای خطوط (بین فراخوانی متدها) توجه شما را جلب کند.<br>این به این خاطر است که هر متدی در آبجکت EntityFieldQuery به عنوان مقدار بازگشتی، دوباره همان آبجکت EntityFieldQuery مورد عمل را باز می گرداند و این ویژگی امکان فراخوانی زنجیره ای متدها را فراهم می کند. و باعث خوانایی بیشتر و سرعت بیشتر در کدنویسی می شود.</p><p>ویژگی فوق برای کسانی که قبلا با jQuery کار کرده اند نیز آشنا است. کد فوق را می توانستیم به صورت زیر هم بنویسیم:</p><pre class="brush:php">
$query->entityCondition('entity_type', 'node')->entityCondition('bundle', 'article')->propertyCondition('status', 1)->propertyOrderBy('created', 'DESC');
</pre><p>اما در این صورت، خوانایی کد کم می شود. توصیه می شود که همیشه فراخوانی هر متد را در یک خط جدید قرار دهید.</p><p>اکنون اجازه دهید که به تک تک خطوط کد فوق بپردازیم و کاری که انجام می دهند را شرح دهیم:</p><pre class="brush:php">
->entityCondition('entity_type', 'node')
</pre><p>اولین فراخوانی، از متد entityCondition استفاده می کند و مشخص می کند که می خواهیم از entity های نوع node گزارش گیری کنیم. توجه کنید که در دروپال entity های گوناگونی داریم به عنوان مثال node ها و user ها و taxonomy term ها و comment ها همگی انواع مختلف entity به حساب می آیند.</p><pre class="brush:php">
->entityCondition('bundle', 'article')
</pre><p>متد entityCondition شرایط خاصی را بر روی entity های موجود در گزارش اعمال می کند. در خط فوق، ما bundle را به عنوان آرگومان اول استفاده کردیم. به این ترتیب می توانیم گزارش مان را به node type های خاصی محدود کنیم. اگر بخواهیم همه ی node ها را صرف نظر از نوع شان شامل کنیم، می توانیم خط فوق را حذف کنیم.</p><p>نکته: توجه کنید که هر entity ممکن است دارای تعدادی bundle باشد. مثلا node دارای content type است. هر content type در واقع یک bundle از node است.</p><p>به عنوان مثال دیگر، Taxonomy می تواند شامل تعدادی vocabulary باشد. هر vocabulary یک bundle به حساب می آید...</p><p>همانطور که حدس می زنید، در دستور فوق مشخص کردیم که می خواهیم فقط از node های نوع article در query مان استفاده کنیم. توجه کنید که آرگومان دوم entityCondition می تواند یک رشته و یا یک آرایه باشد. به عنوان مثال اگر بخواهیم هم article و هم page ها را شامل کنیم، می توانیم خط فوق را به صورت زیر تغییر دهیم:</p><pre class="brush:php">
->entityCondition('bundle', array('article', 'page'))
</pre><p>همانطور که می بینید، خیلی ساده می توانید query تان را گسترش بدهید.</p><pre class="brush:php">
->propertyCondition('status', 1)
</pre><p>متد بعدی propertyCondition است. در اینجا، property به معنی یک فیلد در جدول اصلی entity مورد عمل می باشد. در مورد node ها ، از property می توانیم برای بررسی وضعیت منتشرشده بودن node ، کاربری که node را ایجاد کرده است، تاریخ ایجاد node و ... استفاده کنیم.</p><p>در دستور فوق، EntityFieldQuery را محدود کرده ایم که فقط node های منتشر شده را جمع آوری کند (که فیلد status آن ها 1 است).</p><pre class="brush:php">
->propertyOrderBy('created', 'DESC')
</pre><p>متد propertyOrderBy در مثال فوق، برای تنظیم شیوه ی مرتب سازی نتایج استفاده می شود. آرگومان اول، نام فیلدی است که مرتب سازی بر اساس آن انجام می گیرد و آرگومان دوم ASC و یا DESC است.</p><h3 style="font-weight:700">پرس و جوی فیلدها و محدود سازی</h3><p>اکنون اجازه دهید که یک پرس و جو بر روی مقدار یک فیلد ایجاد کنیم.</p><p>برای این منظور از متد fieldCondition() استفاده می کنیم. فرض کنید که همه ی انواع node های که مورد پرس و جو قرار می دهیم، دارای یک فیلد به نام field_us_state می باشند.</p><p>قصد داریم که همه ی node هایی که متعلق به منطقه ی New York Tri-state area (که همچنین شامل Connecticut و New Jersey می شود) هستند را پیدا کنیم. این پرس و جو به صورت زیر خواهد شد:</p><pre class="brush:php">
$query->fieldCondition('field_us_state', 'value', array('CT', 'NJ', 'NY'));
</pre><p>در صورتی که بخواهیم می توانیم نتایج را بر روی مقداری فیلدها هم مرتب کنیم. توجه کنید که اگر چند نوع مرتب سازی داشته باشیم، قوانین مرتب سازی به همان ترتیبی که به پرس و جو اضافه شده اند، پردازش می شوند.</p><p>فرض کنید که می خواهیم نتایج را فقط به 10 گزینه ای که جدیدا ایجاد شده اند محدود کنیم. بگذارید یک محدودیت ایجاد کنیم:</p><pre class="brush:php">
$query->range(0,10);
</pre><p>دستور فوق نتایج را به موارد صفر تا 10 محدود می کند.</p><h3 style="font-weight:700">و بفرمایید!</h3><p>در نهایت پرس و جو را اجرا می کنیم تا نتایج را به دست آوریم:</p><pre class="brush:php">
$result = $query->execute();
</pre><p>متد execute() پرس و جو را اجرا می کند و نتایج را به صورت یک آرایه از شناسه های entity ها (entity id) برمی گرداند. (در این جا node id ها یا nid ها) که با شرایط قید شده در پرس و جو منطبق می باشند.</p><p>اگر ما node ها را مورد پرس و جو قرار داده باشیم، نتایج در داخل $result['node'] قرار می گیرند. آن چه که معمولا شما می خواهید، nid هایی است که برگردانده شده اند. برای به دست آوردن آن ها به سادگی می توانید از دستور زیر استفاده کنید:</p><pre class="brush:php">
$nids = array_keys($result['node']);
</pre><p>کل کدی که نوشتیم به صورت زیر خواهد بود:</p><pre class="brush:php">
$query = new EntityFieldQuery();
$query
  ->entityCondition('entity_type', 'node')
  ->entityCondition('bundle', 'article')
  ->propertyCondition('status', 1)
  ->propertyOrderBy('created', 'DESC')
  ->fieldCondition('field_us_state', 'value', array('CT', 'NJ', 'NY'))
  ->range(0,10);
$result = $query->execute();
$nids = array_keys($result['node']);
</pre><p>نسبت به نتیجه ی عالی ای که گرفیتم، اصلا کد زیادی ننوشتیم!<br>از این مهم تر این است که نیازی به دانش SQL و مهم تر از آن زیر ساخت ذخیره ی اطلاعات در پایگاه داده نداشتیم و همه چیز به طور خودکار انجام شد.<br>ما فقط پرس و جو را به شیوه ی ساده ی EntityFieldQuery می نویسیم و API قدرتمند دروپال آن را به یک query قابل درک توسط لایه ی انتزاعی پایگاه داده ی دروپال تبدیل می کند و اجرا کرده و نتایج را به فرمت مناسبی برای ما آماده می کند.</p><p>اکنون ما با یک لیست از node id ها چه کاری می توانیم انجام دهیم؟ مسلما هر کاری که بخواهیم! به عنوان مثال ممکن است بخواهیم همه ی node های بدست آمده را load کنیم:</p><pre class="brush:php">
$nodes = node_load_multiple($nids);
</pre><p>همچنین ممکن است بخواهیم node های بدست آمده را به صورت گروهی و در مود teaser نمایش دهیم که آن هم به سادگی قابل اجرا خواهد بود. اجازه دهید که یک آرایه ی قابل render ایجاد کنیم:</p><pre class="brush:php">
$output = node_view_multiple($nodes);
</pre><p>این فقط یک شروع بود. EntityFieldQuery یک کلاس بسیار قدرتمند است و می توانید مستندات آن را در سایت Drupal.org مطالعه کنید.</p><p>موفق باشید.</p><h5>این مقاله از صفحه ی زیر برداشت شده است:
http://treehouseagency.com/blog/tim-cosgrove/2012/02/16/entityfieldquery-let-drupal-do-heavy-lifting-pt-1
با تشکر فراوان از Tim Cosgrove</h5><h5>مطالب مرتبط:</h5><ul><li><a href="/posts/1390/11/%D8%A7%D8%AC%D8%B1%D8%A7%DB%8C-view-%D9%88-%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87-%D8%A7%D8%B2-%D8%AE%D8%B1%D9%88%D8%AC%DB%8C-%D8%A2%D9%86-%D8%AF%D8%B1-%DA%A9%D8%AF%D9%86%D9%88%DB%8C%D8%B3%DB%8C/">اجرای View و استفاده از خروجی آن در کدنویسی</a></li><li><a href="/posts/1393/02/%D9%86%D8%B5%D8%A8-drush-%D8%A8%D9%87-%D8%B4%DB%8C%D9%88%D9%87-%DB%8C-%D8%AC%D8%AF%DB%8C%D8%AF/">نصب Drush به شیوه ی جدید</a></li></ul></article><div id="comments"><script>
      var disqus_config = function () { 
        this.language = "fa";
      };
    </script><div id="disqus_thread"></div><script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hejazee" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><aside class="col-md-3 mt-4"><h3>Monthly Archive</h3><ul><li><a href="/month/1395-06/" title="All posts from 1395-06">1395-06</a> (1)</li><li><a href="/month/1395-01/" title="All posts from 1395-01">1395-01</a> (1)</li><li><a href="/month/1394-12/" title="All posts from 1394-12">1394-12</a> (3)</li><li><a href="/month/1394-08/" title="All posts from 1394-08">1394-08</a> (1)</li><li><a href="/month/1394-07/" title="All posts from 1394-07">1394-07</a> (1)</li><li><a href="/month/1394-03/" title="All posts from 1394-03">1394-03</a> (1)</li><li><a href="/month/1394-02/" title="All posts from 1394-02">1394-02</a> (1)</li><li><a href="/month/1393-12/" title="All posts from 1393-12">1393-12</a> (1)</li><li><a href="/month/1393-07/" title="All posts from 1393-07">1393-07</a> (1)</li><li><a href="/month/1393-06/" title="All posts from 1393-06">1393-06</a> (2)</li><li><a href="/month/1393-05/" title="All posts from 1393-05">1393-05</a> (2)</li><li><a href="/month/1393-04/" title="All posts from 1393-04">1393-04</a> (4)</li><li><a href="/month/1393-03/" title="All posts from 1393-03">1393-03</a> (5)</li><li><a href="/month/1393-02/" title="All posts from 1393-02">1393-02</a> (1)</li><li><a href="/month/1393-01/" title="All posts from 1393-01">1393-01</a> (4)</li><li><a href="/month/1392-12/" title="All posts from 1392-12">1392-12</a> (5)</li><li><a href="/month/1392-10/" title="All posts from 1392-10">1392-10</a> (5)</li><li><a href="/month/1392-06/" title="All posts from 1392-06">1392-06</a> (1)</li><li><a href="/month/1392-04/" title="All posts from 1392-04">1392-04</a> (1)</li><li><a href="/month/1392-02/" title="All posts from 1392-02">1392-02</a> (1)</li><li><a href="/month/1392-01/" title="All posts from 1392-01">1392-01</a> (5)</li><li><a href="/month/1391-11/" title="All posts from 1391-11">1391-11</a> (5)</li><li><a href="/month/1391-10/" title="All posts from 1391-10">1391-10</a> (4)</li><li><a href="/month/1391-09/" title="All posts from 1391-09">1391-09</a> (2)</li><li><a href="/month/1391-08/" title="All posts from 1391-08">1391-08</a> (3)</li><li><a href="/month/1391-07/" title="All posts from 1391-07">1391-07</a> (6)</li><li><a href="/month/1391-05/" title="All posts from 1391-05">1391-05</a> (1)</li><li><a href="/month/1391-04/" title="All posts from 1391-04">1391-04</a> (1)</li><li><a href="/month/1391-03/" title="All posts from 1391-03">1391-03</a> (2)</li><li><a href="/month/1391-02/" title="All posts from 1391-02">1391-02</a> (4)</li><li><a href="/month/1391-01/" title="All posts from 1391-01">1391-01</a> (6)</li><li><a href="/month/1390-12/" title="All posts from 1390-12">1390-12</a> (9)</li><li><a href="/month/1390-11/" title="All posts from 1390-11">1390-11</a> (8)</li><li><a href="/month/1390-10/" title="All posts from 1390-10">1390-10</a> (7)</li><li><a href="/month/1390-09/" title="All posts from 1390-09">1390-09</a> (4)</li><li><a href="/month/1390-08/" title="All posts from 1390-08">1390-08</a> (7)</li><li><a href="/month/1390-07/" title="All posts from 1390-07">1390-07</a> (14)</li><li><a href="/month/1390-06/" title="All posts from 1390-06">1390-06</a> (18)</li></ul></aside></div></div><footer id="footer-wrapper"><div id="footer-bottom-wrapper"><div class="container"><div class="row"><div class="col-12"><p dir="ltr">&copy; Copyright 2011-2022 * Ahmad Hejazee * All rights reserved.</p><small dir="ltr">Proudly Powered by Drupal 10 ;)</small></div></div></div></div></footer><script src="/lib/jQuery/jquery-3.6.0.min.js"></script>
<script src="/lib/bootstrap-5.1.3-dist/js/bootstrap.bundle.min.js"></script></body></html>